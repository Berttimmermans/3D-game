!function(){function a(){return{pos:{x:30,y:320,z:100},cam:{rx:315,ry:315,rz:0},speed:1.5,size:20,floor:100,gravity:3,jumpHeight:30,jumpY:0,mode:"moving",directory:"img/LVL-1-logic-map.png"}}function b(){this.d=a(),this.mode="walk",this.cam=document.getElementById("cam"),this.map=document.getElementById("map"),this.charachter=document.getElementById("charachter"),this.buildLogicMap()}b.prototype.buildLogicMap=function(){this.logicMap=document.createElement("canvas"),this.logicMapContext=this.logicMap.getContext("2d");var a=new Image,b=this;a.onload=function(){b.logicMap.width=this.width,b.logicMap.height=this.height,b.logicMapContext.drawImage(this,0,0)},a.src=this.d.directory},b.prototype.init=function(){this.rotateCam(),this.updatePos()},b.prototype.dPad=function(a){return this.controlDispatcher("dPad",a)},b.prototype.actionButton=function(){return this.controlDispatcher("actionButton")},b.prototype.controlDispatcher=function(a,b){return"walk"==this.mode?this.controlReceiver(a,b):void 0},b.prototype.controlReceiver=function(a,b){"dPad"==a&&this.walk(b),"actionButton"==a&&this.jump()},b.prototype.walk=function(a){a=this.remap(a.x,a.y);var b=this.checkPosition(a.x,a.y);if(b=0!=b?b:this.checkPosition(0,a.y),b=0!=b?b:this.checkPosition(a.x,0),0==b||0==b.x&&0==b.y)return!1;var c=b.z-this.d.pos.z;if(-3>c||c>3){var d=0>c?-(c*this.d.gravity):c*this.d.gravity;this.mode="smooth",this.map.classList.add("transition"),this.updateTiming(d/1e3);var e=this;setTimeout(function(){e.map.classList.remove("transition"),e.updateTiming(0),e.mode="walk"},d)}this.d.pos=b,this.updatePos()},b.prototype.remap=function(a,b){var c=[{x:0,z:-1},{x:1,z:-1},{x:1,z:0},{x:1,z:1},{x:0,z:1},{x:-1,z:1},{x:-1,z:0},{x:-1,z:-1}],d={x:a,z:b},e=parseInt(this.d.cam.ry/45),f=0;for(var g in c)if(c[g].x==d.x&&c[g].z==d.z)var f=parseInt(g);return f=7>=f+e?f+e:f+e-8,{x:c[f].x,y:c[f].z}},b.prototype.checkPosition=function(a,b){a=this.d.pos.x+a*this.d.speed,b=this.d.pos.y+b*this.d.speed,d=[],c=0,size=this.d.size/2;for(var e=-1;2>e;e++)for(var f=-1;2>f;f++){if(d[c]={x:a+f*size,y:b+e*size},p=this.logicMapContext.getImageData(d[c].x,d[c].y,1,1).data,p[0]!=p[1]||p[1]!=p[2])return!1;d[c].z=parseInt(-p[0]/2.55+100),c++}z=d[4].z,maxZ=this.d.pos.z+this.d.jumpY;for(var e in d)if(d[e].z-maxZ>=10)return!1;zHolder=[];for(var e in d)zHolder[e]=d[e].z;return z=Math.max.apply(Math,zHolder),{x:a,y:b,z:z}},b.prototype.jump=function(){function a(a){return b.d.jumpHeight*Math.sin(a*Math.PI/d)}if(0!=this.d.jumpY)return!1;var b=this,c=0,d=b.d.jumpHeight*b.d.gravity*b.d.gravity,e=d/b.d.jumpHeight,f=setInterval(function(){b.d.jumpY=parseInt(a(c)),b.d.jumpY<0&&(b.d.jumpY=0,clearInterval(f)),c+=e,b.translateCharachter(0,-b.d.jumpY,0),b.updatePos()},e)},b.prototype.updatePos=function(){this.map.style.webkitTransform=this.map.style.MozTransform="translate3D(-"+this.d.pos.x+"px,"+(this.d.floor+this.d.pos.z)+"px,-"+this.d.pos.y+"px)"},b.prototype.updateTiming=function(a){this.map.style["-webkit-transition-duration"]=this.map.style["-moz-transition-duration"]=a+"s"},b.prototype.translateCharachter=function(a,b,c){this.charachter.style.webkitTransform=this.charachter.style.MozTransform="translate3D("+a+"px,"+b+"px,"+c+"px)"},b.prototype.rotateCam=function(){this.cam.style.webkitTransform=this.cam.style.MozTransform="rotateX("+this.d.cam.rx+"deg) rotateY("+this.d.cam.ry+"deg) rotateZ("+this.d.cam.rz+"deg)"},window.Game=b}(),function(){function a(a){this.game=a,this.pos={x:0,y:0},this.update,this.interval=10,this.action=!1}a.prototype=function(){function b(){var a=this;window.onkeydown=function(b){var c=b.which;38==c&&(a.pos.y=-1),39==c&&(a.pos.x=1),40==c&&(a.pos.y=1),37==c&&(a.pos.x=-1),(38==c||39==c||40==c||37==c)&&(clearInterval(a.update),a.update=setInterval(function(){return a.game.dPad(a.pos)},a.interval)),32==c&&0==a.action&&(a.action=!0,a.game.actionButton())},window.onkeyup=function(b){var c=b.which;return(38==c||40==c)&&(a.pos.y=0),(39==c||37==c)&&(a.pos.x=0),0==a.pos.x&&0==a.pos.y&&clearInterval(a.update),38==c||39==c||40==c||37==c?a.game.dPad(a.pos):void(32==c&&(a.action=!1))}}return{constructor:a,init:function(){return this._(b)()},_:function(a){var b=this;return function(){return a.apply(b,arguments)}}}}(),window.Keyboard=a}(),function(){function a(a){this.game=a,this.pos={x:0,y:0},this.apos={x:0,y:0,z:0},this.update,this.interval=10}a.prototype.init=function(){self=this,window.DeviceMotionEvent&&(window.ondevicemotion=function(a){self.apos.x=a.accelerationIncludingGravity.x,self.apos.y=a.accelerationIncludingGravity.y,self.apos.z=a.accelerationIncludingGravity.y},setInterval(function(){return self.pos.x=self.apos.y>.5?-1:self.apos.y<-.5?1:0,self.pos.y=self.apos.x>.5?-1:self.apos.x<-.5?1:0,document.getElementById("#dev-data").innerHTML="x= "+parseInt(self.pos.x)+" y= "+parseInt(self.pos.y),self.game.dPad(self.pos)},self.interval))},window.Motion=a}(),window.onload=function(){var a=new Game;a.init();var b=new Keyboard(a);b.init();var c=new Touch(a);c.init()},function(){function a(a){this.game=a,this.pos={x:0,y:0},this.size=160,this.buttonSize=80,this.update,this.interval=10,this.iPad=null!=navigator.userAgent.match(/iPad/i),this.iPhone=null!=navigator.userAgent.match(/iPhone/i),this.iPod=null!=navigator.userAgent.match(/iPod/i),this.android=null!=navigator.userAgent.match(/Android/i)}a.prototype.init=function(){(1==this.iPad||1==this.iPhone||1==this.iPod||1==this.android)&&this.build()},a.prototype.build=function(){var a=this,b=document.createElement("div");b.className="controls",document.body.appendChild(b);var c=document.createElement("div");c.id="dPad";var d=document.createElement("div");d.id="dPad-stick",c.appendChild(d),b.appendChild(c);var e=document.createElement("a");e.id="actionButton",e.innerHTML="A",b.appendChild(e),document.body.addEventListener("touchstart",function(){return event.preventDefault()},!1),c.addEventListener("touchstart",function(){a.update=setInterval(function(){return a.game.dPad(a.pos)},a.interval),c.classList.add("active")},!1),c.addEventListener("touchmove",function(b){var d=b.changedTouches[0].pageX,e=b.changedTouches[0].pageY,f={left:c.offsetLeft,top:c.offsetTop},g=d-f.left-a.size/2,h=e-f.top-a.size/2,i=(a.size-a.buttonSize)/2;-i>g&&(g=-i),g>i&&(g=i),-i>h&&(h=-i),h>i&&(h=i),a.translate(g,h),a.pos.x=g<-(a.size/8)?-1:g>a.size/8?1:0,a.pos.y=h<-(a.size/8)?-1:h>a.size/8?1:0},!1),c.addEventListener("touchend",function(){return clearInterval(a.update),c.classList.remove("active"),a.pos={x:0,y:0},a.translate(0,0),a.game.dPad(a.pos)},!1),e.addEventListener("touchstart",function(){a.game.actionButton(),e.classList.add("active")}),e.addEventListener("touchend",function(){e.classList.remove("active")})},a.prototype.translate=function(a,b){object=document.getElementById("dPad-stick"),object.style.webkitTransform="translate("+a+"px,"+b+"px)"},window.Touch=a}();